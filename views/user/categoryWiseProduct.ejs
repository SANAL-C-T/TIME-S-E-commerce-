<%-include("../partials/userloggedHeder.ejs")%>

<div  class="d-flex bg-light ">
  
    <div class=" row">
          
            <div class="sideMenu mt-3 mx-3">
            
                <ul class="nav flex-column">
                    <h6 class="text-center mt-3  "> CATEGORY</h6>
                <!--     <li class="nav-item">
                        <label class="nav-link" for="newlaunch">
                            <input type="radio" id="newlaunch" name="productType" class="form-check-input">
                            NEW LAUNCH
                        </label>
                    </li>
                    <li class="nav-item">
                        <label class="nav-link" for="allproducts">
                            <input type="radio" id="allproducts" name="productType" class="form-check-input">
                            ALL PRODUCTS
                        </label>
                    </li> -->

                    <li class="nav-item">
                        <label class="nav-link" for="APPLE">
                            <input type="radio" id="APPLE" name="productType" class="form-check-input">
                            APPLE
                        </label>
                    </li>

                    <li class="nav-item">
                        <label class="nav-link" for="GARMIN">
                            <input type="radio" id="GARMIN" name="productType" class="form-check-input">
                            GARMIN
                        </label>
                    </li>

                    <li class="nav-item">
                        <label class="nav-link" for="SAMSUNG">
                            <input type="radio" id="SAMSUNG" name="productType" class="form-check-input">
                            SAMSUNG
                        </label>
                    </li>

                <!-- <h6 class="text-center mt-3 "> PRICE</h6>

                    <li class="nav-item">
                        <label class="nav-link" for="Hightolow">
                            <input type="radio" id="Hightolow" name="pricesort" class="form-check-input">
                            High to Low
                        </label>
                    </li>

                    <li class="nav-item">
                        <label class="nav-link" for="lowtohigh">
                            <input type="radio" id="lowtohigh" name="pricesort" class="form-check-input">
                            Low to High
                        </label>
                    </li> -->
                   
           <h6 class="text-center mt-3 "> DISCOUNTED</h6>
                    <li class="nav-item">
                        <label class="nav-link" for="nodiscounted">
                            <input type="radio" id="nodiscounted" name="discounted" class="form-check-input">
                            No Discounted
                        </label>

                        <label class="nav-link" for="discounted">
                            <input type="radio" id="discounted" name="discounted" class="form-check-input">
                            Discounted
                        </label>

                    </li>
                </ul>
            
            </div>
         
            
          </div>
    


<style>
            table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 5px;
            }
    
            th, td {
                border: 1px solid #000000;
                padding: 3px;
                text-align: left;
            }
    
            th {
                background-color: #f9c001;
            }


            
            #proimg { 
                
                height: 250px;
              }

              
              #txtcrd {
                height: 50px;
              }
              


</style>



<main class="col-md-9 ms-sm-auto col-lg-10 md-4">


<section style="background-color: #f0f0f0;">
        <div class="text-center container py-5  ">
        <h4 class="mt-4 mb-5  nam"><strong><%=catwise.productCategory.
            categoryName%></strong></h4>

            <form class="form-inline my-2 my-lg-0">
                <input class="form-control mr-sm-2" type="search" placeholder="Search" name="ser" id="serh" aria-label="Search">
                <button class="btn btn-success my-4" type="submit">Search</button>
              </form>

<div class="row pdlist">
<!-- ---------------------------------------------------------------------------------------------- -->
    <% catlist.forEach(product => { %>
    
        <div class="col-lg-3 col-md-12 mb-4">
            <div class="card h-100">
                <div class="bg-image hover-zoom ripple ripple-surface ripple-surface-light" data-mdb-ripple-color="light">
                    <img src="<%= product.productImage[0].image1%>" class="w-100" id="proimg"/>
                </div>
                <div class="card-body">
                   
                        <div><h5 class="card-title mb-3" id="txtcrd"><%= product.productName %></h5></div>
                  
                    <a href="/productpage/<%= product._id %>" class="text-reset">
                        <button class="m-2 bg-warning px-4 ">BUY NOW</button>
                    </a>
                    <h6 class="mb-3">â‚¹ <%= product.productPrice %></h6>
                </div>
            </div>
        </div>
    <% }) %>

    <!--  --------------------------------------------------------------------------------------- -->
</div>  <!-- row closing -->
<div class="pagination_div w-100  d-flex justify-content-center">
    <nav aria-label="Page navigation example">
        <ul class="pagination d-flex">
            <% for (let i = 1; i <= Math.ceil(docCount / 4); i++) { %>
                <li class="page-item <%= i === i ? 'active' : '' %>">
                    <a class="page-link" onclick="newProductlist(i)"><%= i %></a>
                </li>
            <% } %>
        </ul>
    </nav>
</div>
  </section>


</main>

</div>



<%-include("../partials/footer.ejs")%>

<script>

    let re;
  document.addEventListener('DOMContentLoaded', async function () {
        const filters = document.querySelectorAll('input[name=productType]');
        const sorts = document.querySelectorAll('input[name=pricesort]');
        const discounts = document.querySelectorAll('input[name=discounted]');
        const searchInputs = document.querySelector('input[name="ser"]');
        const page = 1;

       console.log(searchInputs)
           
        filters.forEach((selection)=>{
            selection.addEventListener("change",newProductlist);
        })
        sorts.forEach((selection)=>{
            selection.addEventListener("change",newProductlist);
        })
        discounts.forEach((selection)=>{
            selection.addEventListener("change",newProductlist);
        })
        searchInputs.addEventListener("input",newProductlist);
       
        newProductlist(page);

    });

    
            async function newProductlist(page){
                
                const productType=document.querySelector('input[name=productType]:checked');
                const discounted=document.querySelector('input[name=discounted]:checked');
                const pricesort=document.querySelector('input[name=pricesort]:checked');
                const ser = document.querySelector('input[name=ser]').value; 
                re=ser;
                
                try{
                  //posting the user input to backend.
                const responseData= await fetch("/api/productfilter",{
                    method:"POST",
                    headers:{
                        "Content-Type":"application/json"
                    },
                    body:JSON.stringify({
                        productType: productType ? productType.id : null,
                        discounted: discounted ? discounted.id : null,
                        pricesort: pricesort ? pricesort.id : null,
                        page:page,
                        ser:ser,
                    }),
                    
                })
               
                    const data=await responseData.json() //incoming data from backend is here.

                    console.log("frontend",data)

                    updateTitle(data);//updating the page title

                    updateProductHTML(data);//updating the page content.
                   
                }
                catch(error){
                    console.log(error.message);
                }

            }

            
            var lock;//non selected category manager.
            function updateTitle(data) {
                const title = document.querySelector(".nam");
                if (data.productType) {
                    lock=0;
                    title.innerHTML = `<h4 class="mt-4 mb-5"><strong>${data.productType}</strong></h4>`;
                } else {
                lock=1;
                }
            }
            
            
            
        
//...................product card..........................

            function updateProductHTML(data) {
                const contain = document.querySelector(".pdlist");
                const productType=document.querySelector('input[name=productType]:checked');
                console.log("update product data in ui",data)
 
               if(lock!=1){
                    contain.innerHTML = '';
                  
                }
                let cards=[] 
                
                if (re=="") {
                  
                    data.products.forEach(product => {
                        const cardHTML = `<div class="col-lg-3 col-md-12 mb-4 ">
                            <div class="card h-100">
                                <div class="bg-image hover-zoom ripple ripple-surface ripple-surface-light" data-mdb-ripple-color="light">
                                    <img src="${product.productImage[0].image1}" class="w-100" id="proimg" style="height: 250px;"/>

                                </div>
                                <div class="card-body">
                                   
                                        <div><h5 class="card-title mb-3" style="height:50px;">${product.productName}</h5></div>
                                  
                                    <a href="/productpage/${product._id}" class="text-reset">
                                        <button class="m-2 bg-warning px-4">BUY NOW</button>
                                    </a>
                                    <h6 class="mb-3">â‚¹ ${product.productPrice}</h6>
                                </div>
                            </div>
                        </div>`
        
                        cards.push(cardHTML)
                    });
                  
                    
                    contain.innerHTML=cards.join("")
                
                   
                     const paginations=document.querySelector('.pagination')
     
                    paginations.innerHTML = generatePagination(data.docCount, data.a);
                   
            
                } else if(re==""||re!=""&&productType!=null) {
               
                 
                    data.serc.forEach(product => {
                        const cardHTML = `<div class="col-lg-3 col-md-12 mb-4">
                            <div class="card h-100">
                                <div class="bg-image hover-zoom ripple ripple-surface ripple-surface-light" data-mdb-ripple-color="light">
                                    <img src="${product.productImage[0].image1}" class="w-100" id="proimg" style="height: 250px/>
                                </div>
                                <div class="card-body">
                                    
                                        <div><h5 class="card-title mb-3" id="txtcrd">${product.productName}</h5></div>
                                   
                                    <a href="/productpage/${product._id}" class="text-reset">
                                        <button class="m-2 bg-warning px-4">BUY NOW</button>
                                    </a>
                                    <h6 class="mb-3">â‚¹ ${product.productPrice}</h6>
                                </div>
                            </div>
                        </div>`
        
                        cards.push(cardHTML)
                    });
                  
                    contain.innerHTML = cards.join("");
                    
            }
            

 //......pagination section..........................................
 function generatePagination(totalProducts, currentPage) {
    const totalPages = Math.ceil(totalProducts / 4);
    let paginationHTML = `<nav aria-label="Page navigation example"><ul class="pagination">`;

    for (let i = 1; i <= totalPages; i++) {
        paginationHTML += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                            <a class="page-link" onclick="newProductlist(${i})">${i}</a>
                          </li>`;
    }

    paginationHTML += `</ul></nav>`;
    return paginationHTML;
}

        }


</script>







